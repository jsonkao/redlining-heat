---
title: "Analysis"
output: html_document
---

```{r setup, include=FALSE}
library(foreign)
library(jsonlite)
library(dplyr)
library(ggplot2)
library(data.table)
```

# Impervious surfaces + temperature analysis

Reference: https://developers.google.com/earth-engine/datasets/catalog/USGS_NLCD_RELEASES_2016_REL#bands
I weighted the impervious data so the contribution of each kind of pixel (e.g. road vs nonroad) was weighted by the percentage of that pixel that was impervious. However this means I need to get total counts from the unweighted version.
```{r}
impv_data_unweighted <- fromJSON("../data/task-exports/impervious-2016-unweighted.json") %>% 
  mutate_all(~replace(., is.na(.), 0)) %>% 
  mutate(n_total = select(., starts_with("freq")) %>% rowSums()) %>% 
  select(id, n_total)

impv_data <- fromJSON("../data/task-exports/impervious-2016.json") %>% 
  mutate_all(~replace(., is.na(.), 0)) %>% 
  mutate(n_road = freq1+freq2+freq3+freq4+freq5+freq6, n_nonroad = freq9+freq10, n_energy = freq11) %>% 
  inner_join(impv_data_unweighted) %>% 
  select(-starts_with("freq"))
setDT(impv_data)
impv_data
```

```{r}
tree_data <- fromJSON("../data/task-exports/tree-2016.json")
setDT(tree_data)
tree_data
```


# Read and join rest of data
```{r}
data <- inner_join(
  inner_join(
    read.dbf('../data/holc-shapefile/holc_ad_data.dbf'),
    impv_data %>% 
      mutate(prop_road = n_road/n_total, prop_nonroad = n_nonroad/n_total, prop_imp = prop_road+prop_nonroad) %>% 
      inner_join(tree_data) %>% 
      select(id, starts_with("prop")),
      by = c('neighborho' = 'id')
  ),
  rbind(fromJSON('../data/task-exports/temperatures-2020.json'), fromJSON('../data/task-exports/temperatures-2000.json')),
  by = c('neighborho' = 'id')
) %>% 
  rename(holc_grade = holc_grade.x) %>% 
  filter(holc_grade != 'E') %>% 
  select(state, city, holc_grade, temperature, year, starts_with("prop"))
setDT(data)
```

# Viz and analysis

Scatter plot and linear trendline
```{r}
TukeyHSD(aov(prop_tree ~ holc_grade, data = data %>% filter(year == 2020)))
```

```{r}
library(ggpmisc)

# State facet
data %>% 
  filter(year == 2020 & as.integer(state) < 12) %>% 
  ggplot(aes(prop_tree, temperature, color = holc_grade)) +
  geom_smooth(method = "lm", se=FALSE, formula = y ~ x) +
  geom_point(alpha = 0.6) +
  stat_poly_eq(formula = y ~ x, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE) +
  facet_wrap(~ state, scales = "free")

# looking at a city to check vibes
data %>% 
  filter(year == 2020 & city == "Portland") %>% 
  ggplot(aes(prop_tree, temperature, color = holc_grade)) +
  geom_smooth(method = "lm", se=FALSE, formula = y ~ x) +
  geom_point(alpha = 0.6) +
  stat_poly_eq(formula = y ~ x, 
               aes(label = paste(..eq.label.., ..rr.label.., sep = "~~~")), 
               parse = TRUE)
```







